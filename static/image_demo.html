<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viamigo Image System Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header img {
            height: 60px;
            margin-bottom: 15px;
        }
        
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.5em;
        }
        
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        
        .stats-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .attractions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .attraction-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .attraction-card:hover {
            transform: translateY(-5px);
        }
        
        .attraction-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        
        .attraction-info {
            padding: 20px;
        }
        
        .attraction-city {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .attraction-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .attraction-details {
            color: #666;
            font-size: 0.9em;
        }
        
        .test-controls {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
            transition: background 0.3s ease;
        }
        
        .test-button:hover {
            background: #5a67d8;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="viamigologo_real.png" alt="Viamigo Logo">
            <h1>üñºÔ∏è Image System Demo</h1>
            <p>Testing PostgreSQL-based image storage with online fallbacks</p>
        </div>

        <div class="stats-section">
            <h3>üìä Image Database Statistics</h3>
            <div id="stats-content" class="loading">
                <div class="spinner"></div>Loading image statistics...
            </div>
        </div>

        <div class="test-controls">
            <h3>üß™ Test Controls</h3>
            <button class="test-button" onclick="loadTestAttractions()">Load Test Attractions</button>
            <button class="test-button" onclick="testImageSearch()">Test Image Search</button>
            <button class="test-button" onclick="clearCache()">Clear Cache</button>
            <button class="test-button" onclick="refreshStats()">Refresh Stats</button>
        </div>

        <div id="attractions-section">
            <h3>üèõÔ∏è Italian Attractions</h3>
            <div id="attractions-grid" class="attractions-grid">
                <div class="loading">
                    <div class="spinner"></div>Loading attractions...
                </div>
            </div>
        </div>
    </div>

    <!-- Include our image management system -->
    <script src="/static/js/viamigo-images.js"></script>
    
    <script>
        // Demo data for Italian attractions
        const testAttractions = [
            { city: 'Roma', name: 'Colosseo', fallback: 'https://images.unsplash.com/photo-1552832230-c0197040d963?w=400' },
            { city: 'Roma', name: 'Fontana di Trevi', fallback: 'https://images.unsplash.com/photo-1531572753322-ad063cecc140?w=400' },
            { city: 'Roma', name: 'Pantheon', fallback: 'https://images.unsplash.com/photo-1515542622106-78bda8ba0e5b?w=400' },
            { city: 'Firenze', name: 'Duomo di Firenze', fallback: 'https://images.unsplash.com/photo-1543832923-44667a44c804?w=400' },
            { city: 'Firenze', name: 'Ponte Vecchio', fallback: 'https://images.unsplash.com/photo-1518307697693-e7a7e6e36b2d?w=400' },
            { city: 'Venezia', name: 'Piazza San Marco', fallback: 'https://images.unsplash.com/photo-1514890547357-a9ee288728e0?w=400' },
            { city: 'Venezia', name: 'Ponte di Rialto', fallback: 'https://images.unsplash.com/photo-1522199670076-2ac386793d85?w=400' },
            { city: 'Milano', name: 'Duomo di Milano', fallback: 'https://images.unsplash.com/photo-1513581166391-887a96ddeafd?w=400' },
            { city: 'Napoli', name: 'Castel Nuovo', fallback: 'https://images.unsplash.com/photo-1605720838999-0a1a9e8f8e98?w=400' },
            { city: 'Pisa', name: 'Torre di Pisa', fallback: 'https://images.unsplash.com/photo-1525874684015-58379d421a52?w=400' }
        ];

        // Load and display image statistics
        async function loadImageStats() {
            try {
                const stats = await ViamigoImages.getImageStats();
                const statsContent = document.getElementById('stats-content');
                
                if (stats) {
                    statsContent.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${stats.overall.total_images}</div>
                                <div class="stat-label">Total Images</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.overall.cities_count}</div>
                                <div class="stat-label">Cities</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.overall.total_size_mb} MB</div>
                                <div class="stat-label">Total Size</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${Math.round(stats.overall.avg_size_bytes / 1024)} KB</div>
                                <div class="stat-label">Avg Size</div>
                            </div>
                        </div>
                    `;
                } else {
                    statsContent.innerHTML = '<p style="text-align: center; color: #999;">Unable to load statistics</p>';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-content').innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading statistics</p>';
            }
        }

        // Load and display test attractions
        async function loadTestAttractions() {
            const grid = document.getElementById('attractions-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading attractions...</div>';

            try {
                // Preload images
                await ViamigoImages.preloadImages(testAttractions.map(attr => ({
                    city: attr.city,
                    attraction: attr.name,
                    fallback: attr.fallback
                })));

                // Create attraction cards
                const cards = await Promise.all(testAttractions.map(async (attr) => {
                    const imageUrl = await ViamigoImages.getImageUrl(attr.city, attr.name, attr.fallback);
                    
                    return `
                        <div class="attraction-card">
                            <div class="attraction-image" style="background-image: url(${imageUrl}); background-size: cover; background-position: center;">
                            </div>
                            <div class="attraction-info">
                                <div class="attraction-city">üìç ${attr.city}</div>
                                <div class="attraction-name">${attr.name}</div>
                                <div class="attraction-details">
                                    Image source: ${imageUrl.startsWith('/api/') ? 'Local Database' : imageUrl.startsWith('data:') ? 'Generated Placeholder' : 'External URL'}
                                </div>
                            </div>
                        </div>
                    `;
                }));

                grid.innerHTML = cards.join('');
            } catch (error) {
                console.error('Error loading attractions:', error);
                grid.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading attractions</p>';
            }
        }

        // Test image search functionality
        async function testImageSearch() {
            const city = prompt('Enter city name (e.g., Roma, Firenze, Venezia):');
            if (!city) return;

            try {
                const response = await fetch(`/api/images/search?city=${encodeURIComponent(city)}`);
                const data = await response.json();
                
                alert(`Found ${data.count} images for ${city}:\n\n${data.images.map(img => 
                    `‚Ä¢ ${img.attraction_name} (${Math.round(img.size_bytes/1024)}KB)`
                ).join('\n')}`);
            } catch (error) {
                alert('Error searching images: ' + error.message);
            }
        }

        // Clear image cache
        function clearCache() {
            ViamigoImages.cache.clear();
            alert('Image cache cleared!');
        }

        // Refresh statistics
        function refreshStats() {
            loadImageStats();
        }

        // Initialize the demo
        window.addEventListener('DOMContentLoaded', () => {
            loadImageStats();
            loadTestAttractions();
        });
    </script>
</body>
</html>